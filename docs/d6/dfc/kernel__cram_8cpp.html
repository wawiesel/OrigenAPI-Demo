<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.10"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>ORIGEN API: Solver/cram/src/kernel_cram.cpp File Reference</title>
        <!--<link href="../../tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="../../dynsections.js"></script>
        <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
        <link href="../../customdoxygen.css" rel="stylesheet" type="text/css"/>
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="../../doxy-boot.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">ORIGEN API v0.5.2</a>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Overview</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li><a href="../../modules.html"><span>Components</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../d1/d5b/md__c_h_a_n_g_e_l_o_g.html"><span>Changelog</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_bbfb5cf133b5ee2ba5207ad49be3b96c.html">Solver</a></li><li class="navelem"><a class="el" href="../../dir_8f3cde3fac723e4552b5504cffd18f9b.html">cram</a></li><li class="navelem"><a class="el" href="../../dir_6d6fe34b92091976de4942a550a86094.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">kernel_cram.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>CRAM depletion solver.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="../../da/def/kernel__cram_8hpp.html">Origen/Solver/cram/src/kernel_cram.hpp</a>&quot;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;cmath&gt;</code><br />
<code>#include &lt;ctime&gt;</code><br />
<code>#include &lt;iostream&gt;</code><br />
<code>#include &lt;limits&gt;</code><br />
<code>#include &lt;vector&gt;</code><br />
<code>#include &quot;ScaleUtils/SuperLU/SRC/slu_zdefs.h&quot;</code><br />
<code>#include &quot;Standard/Interface/jdebug.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfe/struct_l_ustore.html">LUstore</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:af2e1575f3f81b75079edded741a589e3"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#af2e1575f3f81b75079edded741a589e3">SORT_NUCLIDES</a>&#160;&#160;&#160;1</td></tr>
<tr class="separator:af2e1575f3f81b75079edded741a589e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a730144db7cae69370cb69bd1a67db8ae"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a730144db7cae69370cb69bd1a67db8ae">MAKE_EXPM_INPUT</a>&#160;&#160;&#160;0</td></tr>
<tr class="separator:a730144db7cae69370cb69bd1a67db8ae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5ba87788653e245f06fb028f5a7f6897"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a5ba87788653e245f06fb028f5a7f6897">MAKE_MATLAB_INPUT</a>&#160;&#160;&#160;0</td></tr>
<tr class="separator:a5ba87788653e245f06fb028f5a7f6897"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a47f2e62c0dbebc787052c165afcada0e"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a>&#160;&#160;&#160;&quot;Origen/Manager/Wrapper/kernel_cram.cpp&quot;</td></tr>
<tr class="memdesc:a47f2e62c0dbebc787052c165afcada0e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Identifier for error messages.  <a href="#a47f2e62c0dbebc787052c165afcada0e">More...</a><br /></td></tr>
<tr class="separator:a47f2e62c0dbebc787052c165afcada0e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a246b07e575efe303e340da78c4e3e15c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a246b07e575efe303e340da78c4e3e15c">CopyLU</a> (SuperMatrix *L, SuperMatrix *U, <a class="el" href="../../d6/dfe/struct_l_ustore.html">LUstore</a> *LU)</td></tr>
<tr class="separator:a246b07e575efe303e340da78c4e3e15c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aff5a005e75ba1c528c5f8597d45cb1cb"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#aff5a005e75ba1c528c5f8597d45cb1cb">makeExpmInput</a> (int itot, int a_n, int nnz, doublecomplex *a_val_complex, int *a_ci, int *rp, double delta_t, doublecomplex *Bvals, double **source_term, int source_order, int *ZAI)</td></tr>
<tr class="separator:aff5a005e75ba1c528c5f8597d45cb1cb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8109e19dd4e4009213d14ae3d68214f5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a8109e19dd4e4009213d14ae3d68214f5">makeMatlabInput</a> (int itot, int a_n, doublecomplex *a_val_complex, int *a_ci, int *a_rp, int *ZAI)</td></tr>
<tr class="separator:a8109e19dd4e4009213d14ae3d68214f5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9ce670e6925467c50c380d67ffe4dbd7"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a9ce670e6925467c50c380d67ffe4dbd7">sortCRSnuclides</a> (int a_n, int a_nnz, double **a_val, int **a_ci, int **a_rp, int *newIdx, int *oldIdx, int sort_nuclides, int *ZAI)</td></tr>
<tr class="separator:a9ce670e6925467c50c380d67ffe4dbd7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a280cd76fe988677c00f96930b194e4a4"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a280cd76fe988677c00f96930b194e4a4">kernel_cram</a> (double *n_out, double *n0, double **source_term, int source_order, double delta_t, int itot, int non, int *non0, int *kd, double *diag, double *offdiag, int *loc, int zero_flux_step, int is_adjoint, int cram_order, int internal_steps, int remove_negatives, double cutoff, int *ZAI)</td></tr>
<tr class="separator:a280cd76fe988677c00f96930b194e4a4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a766915c86655672579fe5205b19bc692"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a766915c86655672579fe5205b19bc692">OrigenToCRSMatrix</a> (int *p_a_n, double **p_a_val, int **p_a_ci, int **p_a_rp, int **p_a_diag_idx, int *p_a_nnz, int **p_newIdx, int **p_oldIdx, double **p_src_dummy_n0, int itot, int non, int *non0, int *kd, double *diag, double *offdiag, int *loc, double **source_term, int source_order, int zero_flux_step, int is_adjoint, int sort_nuclides, int *ZAI)</td></tr>
<tr class="separator:a766915c86655672579fe5205b19bc692"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>CRAM depletion solver. </p>
<dl class="section author"><dt>Author</dt><dd>Aarno Isotalo </dd></dl>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="af2e1575f3f81b75079edded741a589e3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SORT_NUCLIDES&#160;&#160;&#160;1</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Sort nuclides if ZAI is provided (logical int). Sorting improves performance by factor of 2. Unless problems arise this should always be on. </p>

<p>Referenced by <a class="el" href="../../da/def/kernel__cram_8hpp.html#a45c654949dcb526cf76cdd65498a4ceb">kernel_cram()</a>.</p>

</div>
</div>
<a class="anchor" id="a730144db7cae69370cb69bd1a67db8ae"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAKE_EXPM_INPUT&#160;&#160;&#160;0</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Controls printing of input for an external test program. For internal testing purposes only. 0 = not printed, 1 = print with separate source, 2 = print with source merged to the matrix with dummy elements </p>

<p>Referenced by <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#aff5a005e75ba1c528c5f8597d45cb1cb">makeExpmInput()</a>.</p>

</div>
</div>
<a class="anchor" id="a5ba87788653e245f06fb028f5a7f6897"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAKE_MATLAB_INPUT&#160;&#160;&#160;0</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Controls printing of the matrix in matlab form (logical int). For internal testing purposes only. </p>

<p>Referenced by <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a8109e19dd4e4009213d14ae3d68214f5">makeMatlabInput()</a>.</p>

</div>
</div>
<a class="anchor" id="a47f2e62c0dbebc787052c165afcada0e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NAME&#160;&#160;&#160;&quot;Origen/Manager/Wrapper/kernel_cram.cpp&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Identifier for error messages. </p>

<p>Referenced by <a class="el" href="../../da/def/kernel__cram_8hpp.html#a45c654949dcb526cf76cdd65498a4ceb">kernel_cram()</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a246b07e575efe303e340da78c4e3e15c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CopyLU </td>
          <td>(</td>
          <td class="paramtype">SuperMatrix *&#160;</td>
          <td class="paramname"><em>L</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SuperMatrix *&#160;</td>
          <td class="paramname"><em>U</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d6/dfe/struct_l_ustore.html">LUstore</a> *&#160;</td>
          <td class="paramname"><em>LU</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Special fun fun copy the L and U matrices in SuperLU format.</p>
<p>This copies the pointers, not their contents. New Store is allocated. nzval (the non-zero values) pointers are also copied but then the nzval pointers in L U are set to point to new, freshly allocated memory. This way the data from L, U is now in LU without copying any memory. nzval in L, U are effectively reset, but they are not needed anyway (L,U are used to store the next LU decomposition for different pole in CRAM so nzval would be overwritten anyway.</p>
<p>Because the pointers, rather than the memory they point to is copied, all copies (except nzval) end up pointing to the same space, i.e., the "work" array in the solver. This works because Every A and thus every L, U has the same sparsity pattern.</p>
<p>The first pair of nzval (for term k=0) will point to work while the rest will point to the new arrays allocated on the previous k in this function.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname"></td><td></td></tr>
  </table>
  </dd>
</dl>

<p>References <a class="el" href="../../d6/dfe/struct_l_ustore.html#a2eaceeb453d85c9186c69a0e61d3a41b">LUstore::L</a>, and <a class="el" href="../../d6/dfe/struct_l_ustore.html#a10fb6c0f207466cbe427755f85cc53d4">LUstore::U</a>.</p>

<p>Referenced by <a class="el" href="../../da/def/kernel__cram_8hpp.html#a45c654949dcb526cf76cdd65498a4ceb">kernel_cram()</a>.</p>
<div class="fragment"><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;{</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    doublecomplex* nzval;</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    <span class="comment">// manually copy all values and pointers in L</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    <span class="comment">// note that the memory pointers point to is not copied</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a2eaceeb453d85c9186c69a0e61d3a41b">L</a>.Stype = L-&gt;Stype;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a2eaceeb453d85c9186c69a0e61d3a41b">L</a>.Dtype = L-&gt;Dtype;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a2eaceeb453d85c9186c69a0e61d3a41b">L</a>.Mtype = L-&gt;Mtype;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a2eaceeb453d85c9186c69a0e61d3a41b">L</a>.nrow = L-&gt;nrow;</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a2eaceeb453d85c9186c69a0e61d3a41b">L</a>.ncol = L-&gt;ncol;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a2eaceeb453d85c9186c69a0e61d3a41b">L</a>.Store = (<span class="keywordtype">void</span>*)SUPERLU_MALLOC( <span class="keyword">sizeof</span>( SCformat ) );</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    SCformat* LS_to = (SCformat*)LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a2eaceeb453d85c9186c69a0e61d3a41b">L</a>.Store;</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    SCformat* LS_from = (SCformat*)L-&gt;Store;</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    LS_to-&gt;nnz = LS_from-&gt;nnz;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    LS_to-&gt;nsuper = LS_from-&gt;nsuper;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    LS_to-&gt;nzval = LS_from-&gt;nzval;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    LS_to-&gt;nzval_colptr = LS_from-&gt;nzval_colptr;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    LS_to-&gt;rowind = LS_from-&gt;rowind;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    LS_to-&gt;rowind_colptr = LS_from-&gt;rowind_colptr;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    LS_to-&gt;col_to_sup = LS_from-&gt;col_to_sup;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    LS_to-&gt;sup_to_col = LS_from-&gt;sup_to_col;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    <span class="comment">// make new nzval for the original L</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="comment">// for supernodal size(nzval) is not nnz, count the actual size</span></div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="keywordtype">int</span> nn = 0;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt;= LS_from-&gt;nsuper; ++i )</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    {</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        <span class="keywordtype">int</span> c = LS_from-&gt;sup_to_col[i];</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        <span class="keywordtype">int</span> nsup = LS_from-&gt;sup_to_col[i + 1] - c;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        nn += nsup *</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;              ( LS_from-&gt;rowind_colptr[c + 1] - LS_from-&gt;rowind_colptr[c] );</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    }</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="comment">// allocate</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    nzval = (doublecomplex*)malloc( nn * <span class="keyword">sizeof</span>( doublecomplex ) );</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    LS_from-&gt;nzval = (<span class="keywordtype">void</span>*)nzval;</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="comment">// Copy all values and pointers in U</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="comment">// Note that the memory pointers point to is not copied</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a10fb6c0f207466cbe427755f85cc53d4">U</a>.Stype = <a class="code" href="../../d5/dc1/namespace_origen.html#aea03b0efe8436243f6b90c7bfffdb759">U</a>-&gt;Stype;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a10fb6c0f207466cbe427755f85cc53d4">U</a>.Dtype = <a class="code" href="../../d5/dc1/namespace_origen.html#aea03b0efe8436243f6b90c7bfffdb759">U</a>-&gt;Dtype;</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a10fb6c0f207466cbe427755f85cc53d4">U</a>.Mtype = <a class="code" href="../../d5/dc1/namespace_origen.html#aea03b0efe8436243f6b90c7bfffdb759">U</a>-&gt;Mtype;</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a10fb6c0f207466cbe427755f85cc53d4">U</a>.nrow = <a class="code" href="../../d5/dc1/namespace_origen.html#aea03b0efe8436243f6b90c7bfffdb759">U</a>-&gt;nrow;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a10fb6c0f207466cbe427755f85cc53d4">U</a>.ncol = <a class="code" href="../../d5/dc1/namespace_origen.html#aea03b0efe8436243f6b90c7bfffdb759">U</a>-&gt;ncol;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a10fb6c0f207466cbe427755f85cc53d4">U</a>.Store = (<span class="keywordtype">void</span>*)SUPERLU_MALLOC( <span class="keyword">sizeof</span>( NCformat ) );</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    NCformat* US_to = (NCformat*)LU-&gt;<a class="code" href="../../d6/dfe/struct_l_ustore.html#a10fb6c0f207466cbe427755f85cc53d4">U</a>.Store;</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    NCformat* US_from = (NCformat*)<a class="code" href="../../d5/dc1/namespace_origen.html#aea03b0efe8436243f6b90c7bfffdb759">U</a>-&gt;Store;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    US_to-&gt;nnz = US_from-&gt;nnz;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    US_to-&gt;nzval = US_from-&gt;nzval;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    US_to-&gt;rowind = US_from-&gt;rowind;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    US_to-&gt;colptr = US_from-&gt;colptr;</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="comment">// make new nzval for the original U</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    nzval = (doublecomplex*)malloc( US_from-&gt;nnz * <span class="keyword">sizeof</span>( doublecomplex ) );</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    US_from-&gt;nzval = (<span class="keywordtype">void</span>*)nzval;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;}</div>
<div class="ttc" id="namespace_origen_html_aea03b0efe8436243f6b90c7bfffdb759"><div class="ttname"><a href="../../d5/dc1/namespace_origen.html#aea03b0efe8436243f6b90c7bfffdb759">Origen::U</a></div><div class="ttdeci">Quantity&lt; Unitless &gt; U</div><div class="ttdef"><b>Definition:</b> History.h:67</div></div>
<div class="ttc" id="struct_l_ustore_html_a10fb6c0f207466cbe427755f85cc53d4"><div class="ttname"><a href="../../d6/dfe/struct_l_ustore.html#a10fb6c0f207466cbe427755f85cc53d4">LUstore::U</a></div><div class="ttdeci">SuperMatrix U</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:56</div></div>
<div class="ttc" id="struct_l_ustore_html_a2eaceeb453d85c9186c69a0e61d3a41b"><div class="ttname"><a href="../../d6/dfe/struct_l_ustore.html#a2eaceeb453d85c9186c69a0e61d3a41b">LUstore::L</a></div><div class="ttdeci">SuperMatrix L</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:55</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="aff5a005e75ba1c528c5f8597d45cb1cb"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void makeExpmInput </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>itot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>a_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>a_nnz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">doublecomplex *&#160;</td>
          <td class="paramname"><em>a_val_complex</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>a_ci</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>a_rp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>delta_t</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">doublecomplex *&#160;</td>
          <td class="paramname"><em>Bvals</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double **&#160;</td>
          <td class="paramname"><em>source_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>source_order</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>ZAI</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Write the CRS matrix to a format used by an external test program "expm". This function exists for development purposes only. The input is written to file "expmInput" in current directory. </p>

<p>References <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a730144db7cae69370cb69bd1a67db8ae">MAKE_EXPM_INPUT</a>, and <a class="el" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a>.</p>

<p>Referenced by <a class="el" href="../../da/def/kernel__cram_8hpp.html#a45c654949dcb526cf76cdd65498a4ceb">kernel_cram()</a>.</p>
<div class="fragment"><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;{</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    FILE* out;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    <span class="keywordtype">int</span>* ccs_ri;</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    <span class="keywordtype">int</span>* ccs_cp;</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    doublecomplex* ccs_val;</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    <span class="keywordtype">int</span> i, j, real_nnz, real_n;</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a730144db7cae69370cb69bd1a67db8ae">MAKE_EXPM_INPUT</a> == 0 )</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    {</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    }</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a730144db7cae69370cb69bd1a67db8ae">MAKE_EXPM_INPUT</a> == 1 )</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    {</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        printf( <span class="stringliteral">&quot;Writing EXPM input (separate source) ... &quot;</span> );</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        real_n = itot;</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    }</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a730144db7cae69370cb69bd1a67db8ae">MAKE_EXPM_INPUT</a> == 2 )</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    {</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        printf( <span class="stringliteral">&quot;Writing EXPM input (merged source) ... &quot;</span> );</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        real_n = a_n;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;    }</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    {</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        fprintf(</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;            stderr, <span class="stringliteral">&quot;MAKE_EXPM_INPUT invalid value %d\n&quot;</span>, <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a730144db7cae69370cb69bd1a67db8ae">MAKE_EXPM_INPUT</a> );</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        std::exit( EXIT_FAILURE );</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;    }</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;    <span class="keywordflow">if</span>( source_order &gt; 0 )</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;    {</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        fprintf( stderr, <span class="stringliteral">&quot;EXPM does not support time dependent source\n&quot;</span> );</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        std::exit( EXIT_FAILURE );</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;    }</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;    <span class="comment">// Make CCS version for outputting to expm (test program)</span></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;    zCompRow_to_CompCol( a_n,</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;                         a_n,</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;                         a_nnz,</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;                         a_val_complex,</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;                         a_ci,</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;                         a_rp,</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;                         &amp;ccs_val,</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;                         &amp;ccs_ri,</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;                         &amp;ccs_cp );</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    real_nnz = 0;</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    <span class="keywordflow">for</span>( j = 0; j &lt; real_n; j++ )</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;        <span class="keywordflow">for</span>( i = ccs_cp[j]; i &lt; ccs_cp[j + 1]; i++ )</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;            <span class="keywordflow">if</span>( ccs_ri[i] &lt; real_n )</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;                <span class="keywordflow">if</span>( ( ccs_val[i].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a> &gt; 0.0 ) || ( ccs_ri[i] == j ) ) real_nnz++;</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;    out = std::fopen( <span class="stringliteral">&quot;expmInput&quot;</span>, <span class="stringliteral">&quot;w&quot;</span> );</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a730144db7cae69370cb69bd1a67db8ae">MAKE_EXPM_INPUT</a> == 1 )</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;        fprintf( out, <span class="stringliteral">&quot;-1\n&quot;</span> );</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;        fprintf( out, <span class="stringliteral">&quot;1\n&quot;</span> );</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    fprintf( out, <span class="stringliteral">&quot;%.15e\n&quot;</span>, delta_t );</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    fprintf( out, <span class="stringliteral">&quot;\n&quot;</span> );</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;    fprintf( out, <span class="stringliteral">&quot;%4d %4d\n&quot;</span>, real_n, real_n );</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; real_n; i++ )</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    {</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;        fprintf( out, <span class="stringliteral">&quot;%4d  %.15e &quot;</span>, i + 1, Bvals[i].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a> );</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;        <span class="keywordflow">if</span>( <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a730144db7cae69370cb69bd1a67db8ae">MAKE_EXPM_INPUT</a> == 1 )</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;        {</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;            <span class="keywordflow">if</span>( source_order == 0 )</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;                fprintf( out, <span class="stringliteral">&quot;%.15e &quot;</span>, source_term[i][0] );</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                fprintf( out, <span class="stringliteral">&quot;%.15e &quot;</span>, 0.0 );</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;        }</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;        <span class="keywordflow">if</span>( ZAI &amp;&amp; ( i &lt; itot ) )</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;            fprintf( out, <span class="stringliteral">&quot;%d\n&quot;</span>, ZAI[i] );</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ZAI )</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;            fprintf( out, <span class="stringliteral">&quot;%d\n&quot;</span>, 9999999 - real_n + i + 1 );</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;            fprintf( out, <span class="stringliteral">&quot;%d\n&quot;</span>, i );</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    }</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;    fprintf( out, <span class="stringliteral">&quot;%4d %d\n&quot;</span>, real_n, real_nnz );</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    <span class="keywordflow">for</span>( j = 0; j &lt; real_n; j++ )</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;        <span class="keywordflow">for</span>( i = ccs_cp[j]; i &lt; ccs_cp[j + 1]; i++ )</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;            <span class="keywordflow">if</span>( ccs_ri[i] &lt; real_n )</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                <span class="keywordflow">if</span>( ( ccs_val[i].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a> &gt; 0.0 ) || ( ccs_ri[i] == j ) )</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                    fprintf( out,</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;                             <span class="stringliteral">&quot;%4d %4d % .15e %d\n&quot;</span>,</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;                             ccs_ri[i] + 1,</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;                             j + 1,</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;                             ccs_val[i].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a>,</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                             666 );</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    std::fclose( out );</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    free( ccs_ri );</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;    free( ccs_cp );</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    free( ccs_val );</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    printf( <span class="stringliteral">&quot;DONE\n&quot;</span> );</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;}</div>
<div class="ttc" id="_fake_factory_8cpp_html_a6deea1c2ba17f0529b284f5013940b9f"><div class="ttname"><a href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a></div><div class="ttdeci">std::shared_ptr&lt; ScaleUtils::Math::MTRand &gt; r</div><div class="ttdef"><b>Definition:</b> FakeFactory.cpp:23</div></div>
<div class="ttc" id="kernel__cram_8cpp_html_a730144db7cae69370cb69bd1a67db8ae"><div class="ttname"><a href="../../d6/dfc/kernel__cram_8cpp.html#a730144db7cae69370cb69bd1a67db8ae">MAKE_EXPM_INPUT</a></div><div class="ttdeci">#define MAKE_EXPM_INPUT</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:31</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a8109e19dd4e4009213d14ae3d68214f5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void makeMatlabInput </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>itot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>a_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">doublecomplex *&#160;</td>
          <td class="paramname"><em>a_val_complex</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>a_ci</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>a_rp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>ZAI</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Write the matrix and ZAI to a .m file </p>

<p>References <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a5ba87788653e245f06fb028f5a7f6897">MAKE_MATLAB_INPUT</a>, and <a class="el" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a>.</p>

<p>Referenced by <a class="el" href="../../da/def/kernel__cram_8hpp.html#a45c654949dcb526cf76cdd65498a4ceb">kernel_cram()</a>.</p>
<div class="fragment"><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;{</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;    FILE* out;</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    <span class="keywordtype">int</span> i, j;</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    <span class="keywordflow">if</span>( <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a5ba87788653e245f06fb028f5a7f6897">MAKE_MATLAB_INPUT</a> == 0 ) <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    printf( <span class="stringliteral">&quot;PRINTING MATLAB FORM (matrix.m)... &quot;</span> );</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    <span class="comment">// the matrix</span></div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;    out = std::fopen( <span class="stringliteral">&quot;matrix.m&quot;</span>, <span class="stringliteral">&quot;w&quot;</span> );</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;    fprintf( out, <span class="stringliteral">&quot;A=zeros(%d,%d);\n&quot;</span>, a_n, a_n );</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )                    <span class="comment">// rows</span></div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;        <span class="keywordflow">for</span>( j = a_rp[i]; j &lt; a_rp[i + 1]; j++ )  <span class="comment">// elements on a row</span></div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;            fprintf( out,</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                     <span class="stringliteral">&quot;A(%4d,%4d)=% .20e;\n&quot;</span>,</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                     i + 1,</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;                     a_ci[j] + 1,</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;                     a_val_complex[j].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a> );</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    fprintf( out, <span class="stringliteral">&quot;\n&quot;</span> );</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    <span class="comment">// ZAI</span></div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    fprintf( out, <span class="stringliteral">&quot;ZAI=zeros(%d,1);\n&quot;</span>, a_n );</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;    <span class="keywordflow">if</span>( ZAI )</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ )</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;            fprintf( out, <span class="stringliteral">&quot;ZAI(%d)=%8d;\n&quot;</span>, i + 1, ZAI[i] );</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ )</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;            fprintf( out, <span class="stringliteral">&quot;ZAI(%d)=%8d;\n&quot;</span>, i + 1, -i - 1 );</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    <span class="keywordflow">for</span>( i = itot; i &lt; a_n; i++ )  <span class="comment">// rows</span></div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;        fprintf( out, <span class="stringliteral">&quot;ZAI(%d)=%8d;\n&quot;</span>, i + 1, 9999990 + i - itot );</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    fprintf( out, <span class="stringliteral">&quot;\n&quot;</span> );</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    std::fclose( out );</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;    printf( <span class="stringliteral">&quot;DONE\n&quot;</span> );</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;}</div>
<div class="ttc" id="kernel__cram_8cpp_html_a5ba87788653e245f06fb028f5a7f6897"><div class="ttname"><a href="../../d6/dfc/kernel__cram_8cpp.html#a5ba87788653e245f06fb028f5a7f6897">MAKE_MATLAB_INPUT</a></div><div class="ttdeci">#define MAKE_MATLAB_INPUT</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:35</div></div>
<div class="ttc" id="_fake_factory_8cpp_html_a6deea1c2ba17f0529b284f5013940b9f"><div class="ttname"><a href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a></div><div class="ttdeci">std::shared_ptr&lt; ScaleUtils::Math::MTRand &gt; r</div><div class="ttdef"><b>Definition:</b> FakeFactory.cpp:23</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a9ce670e6925467c50c380d67ffe4dbd7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sortCRSnuclides </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>a_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>a_nnz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double **&#160;</td>
          <td class="paramname"><em>p_a_val</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int **&#160;</td>
          <td class="paramname"><em>p_a_ci</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int **&#160;</td>
          <td class="paramname"><em>p_a_rp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>newIdx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>oldIdx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>sort_nuclides</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>ZAI</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Sorts nuclides in a CRS matrix decay/transmutation system by ascending ZAI.</p>
<p>Input is a CRS matrix and a ZAI array. ZAI can be nullptr in which case sorting is not performed. The oldIdx and newIdx arrays are generated either way (they are trivial if no sorting was done).</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">a_n</td><td>Size of the CRS matrix A </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">a_nnz</td><td>Number of elements in CRS matrix A </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">p_a_val[a_nnz]</td><td>Non-zero elements of CRS matrix A </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">p_a_ci[a_nnz]</td><td>Column indices of CRS matrix A </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">p_a_rp[itot+1]</td><td>Row pointers of CRS matrix A </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">oldIdx[itot]</td><td>oldIdx[i] is the old index of the nuclide that has new index i </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">newIdx[itot]</td><td>newIdx[i] is the new index of the nuclide that had old index i </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sort_nuclides</td><td>Logical, whether to actually sort the nuclides </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ZAI[itot]</td><td>ZAI identifiers of the nuclides. Can be nullptr in which case sorting is not actually done. (Still needs to be called to set the index arrays.) </td></tr>
  </table>
  </dd>
</dl>

<p>Referenced by <a class="el" href="../../da/def/kernel__cram_8hpp.html#a17888fff360262af994463a57b69e1a3">OrigenToCRSMatrix()</a>.</p>
<div class="fragment"><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;{</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    <span class="keywordtype">double</span>* a_val = *p_a_val;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    <span class="keywordtype">int</span>* a_ci = *p_a_ci;</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    <span class="keywordtype">int</span>* a_rp = *p_a_rp;</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;    <span class="keywordtype">double</span>* na_val;</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    <span class="keywordtype">int</span> *na_ci, *na_rp;</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <span class="keywordtype">int</span> i, j, tmp_ZAI, tmp_idx, idx_na;</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    <span class="comment">/*** initialize the index arrays ***/</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    {</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;        newIdx[i] = i;</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        oldIdx[i] = i;</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;    }</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;    <span class="comment">/*** check that indexing can and should be done ***/</span></div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    <span class="keywordflow">if</span>( sort_nuclides &amp;&amp; !ZAI )</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    {</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;        jDebugLine( <span class="stringliteral">&quot;   WARNING: sort_nuclides = 1 but ZAI is nullptr!&quot;</span> );</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    }</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    <span class="keywordflow">if</span>( !ZAI )</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    {</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;        jDebugLine( <span class="stringliteral">&quot;   Sorting nuclides... NOT DONE: ZAI not provided.&quot;</span> );</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    }</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !sort_nuclides )</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    {</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;        jDebugLine( <span class="stringliteral">&quot;   Sorting nuclides... NOT DONE: sort_nuclides = 0&quot;</span> );</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    }</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    {</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        jDebugLine( <span class="stringliteral">&quot;   Sorting nuclides...&quot;</span> );</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    }</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;    <span class="comment">/*** sort ZAI (insertion sort) ***/</span></div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;    {  <span class="comment">// nuclides</span></div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;        <span class="comment">// move the idx_a:th element left until the left side is sorted</span></div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;        tmp_ZAI = ZAI[i];</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;        tmp_idx = oldIdx[i];</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;        j = i;</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;        <span class="comment">// move each element that should be after idx_a:th one to the right</span></div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;        <span class="keywordflow">while</span>( ( j &gt; 0 ) &amp;&amp; ( j &lt; a_n ) &amp;&amp; ( ZAI[j - 1] &gt; tmp_ZAI ) )</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;        {</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;            ZAI[j] = ZAI[j - 1];</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;            oldIdx[j] = oldIdx[j - 1];</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;            j--;</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        }</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;        <span class="comment">// put the moved element</span></div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;        ZAI[j] = tmp_ZAI;</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        oldIdx[j] = tmp_idx;</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    }</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;    <span class="comment">/*** fill in newIdx ***/</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ ) newIdx[oldIdx[i]] = i;</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    <span class="comment">/*** change the column indices ***/</span></div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_nnz; i++ ) a_ci[i] = newIdx[a_ci[i]];</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    <span class="comment">/*** rearrange the rows ***/</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    na_val = (<span class="keywordtype">double</span>*)calloc( a_nnz, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    na_ci = (<span class="keywordtype">int</span>*)calloc( a_nnz, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    na_rp = (<span class="keywordtype">int</span>*)calloc( a_n + 1, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    idx_na = 0;  <span class="comment">// index in na</span></div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    {  <span class="comment">// i = NEW rows</span></div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;        <span class="comment">// row j=oldIdx[i] becomes row i</span></div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;        j = oldIdx[i];</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;        na_rp[i] = idx_na;</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;        std::copy( a_val + a_rp[j], a_val + a_rp[j + 1], na_val + idx_na );</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;        std::copy( a_ci + a_rp[j], a_ci + a_rp[j + 1], na_ci + idx_na );</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;        idx_na += a_rp[j + 1] - a_rp[j];</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    }</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    na_rp[a_n] = a_nnz;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;    <span class="comment">/*** free the old a ***/</span></div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    free( a_val );</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    free( a_ci );</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    free( a_rp );</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    <span class="comment">/*** set the return pointers to new a ***/</span></div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    *p_a_val = na_val;</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    *p_a_ci = na_ci;</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;    *p_a_rp = na_rp;</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a280cd76fe988677c00f96930b194e4a4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int kernel_cram </td>
          <td>(</td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>n_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>n0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double **&#160;</td>
          <td class="paramname"><em>source_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>source_order</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>delta_t</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>itot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>non</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>non0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>offdiag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>loc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>zero_flux_step</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>is_adjoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>cram_order</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>internal_steps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>remove_negatives</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>cutoff</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>ZAI</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>CRAM depletion solver with source term and adjoint capabilities.</p>
<p>Based on the publication: Pusa, M. and Leppnen, J. "Computing the matrix exponential in burnup
  calculations." Nucl. Sci. Eng., 164 (2010) 140-150.</p>
<p>The required linear system solutions are done with the SuperLU library: Xiaoye S. Li. "An Overview of {SuperLU}: Algorithms, Implementation, and
  User Interface." ACM Trans.Math. Softw., 31;3 (2005) 302-325.</p>
<p><b>Fortran</b> should call <a class="el" href="../../da/def/kernel__cram_8hpp.html#aa519e485bd96a0c81aa4d4fd56b96926">kernel_cram_from_fortran()</a> instead.</p>
<p><b>Source term</b> can have polynomial time dependency. Due to numerical issues source order is limited to cram_order/2-2. Non constant source term will cause some deterioration in accuracy, but below this limit it should be negligible.</p>
<p><b>Adjoint calculation</b> is also possible by passing is_adjoint=1. In adjoint mode n0, source_term and delta_t&gt;0 must be those for the adjoint problem while everything else must have values defining the forward system.</p>
<p><b>Internal substeps:</b> Dividin steps to pieces greatly improved accuracy. This is particularly significant for decay problems where accuracy without might not be good enough for all purposes. The solver can do this division internally, which is more efficient than calling the solver multiple times as the LU decompositions only need to be formed once. internal_steps=1 means means that there is no substepping. Setting internal_steps=2 increases running time by roughly 25%. Each substep above 2 increases it by another 10-15% of the running time without substepping. See *** for details.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">n_out[itot]</td><td>Final concentrations. Must be Pre-allocated. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n0[itot]</td><td>Initial concentrations </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">source_term[itot][source_order+1]</td><td>Polynomial coefficients s_i,j for the source term </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">source_order</td><td>Order of the source term polynomial </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">delta_t</td><td>Length of the time step in seconds </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">itot</td><td>The number of nuclides in the system </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">non</td><td>Number of reactions (inc. decay) in the system </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">non0[itot]</td><td>Number of parents for each nuclide </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kd[itot]</td><td>Number of decay parents for each nuclide </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">diag[itot]</td><td>Diagonal elements of A, i.e., (-lambda_eff) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">offdiag[non]</td><td>Reaction specific decay constant of each reaction. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">loc[non]</td><td>Index of the parent in each reaction. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">zero_flux_step</td><td>Logical integer, is the flux zero? </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">is_adjoint</td><td>Logical integer, is this adjoint calculation? </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cram_order</td><td>Order of the CRAM approximation (just use 16). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">internal_steps</td><td>Number of internal substeps to use </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">remove_negatives</td><td>How to treat negative vaues in results: 0: Do nothing. 1: Remove all negative values. 2: Remove all negative values in forward mode. Remove all negative values in adjoint mode if source term is constant and both source and initial concentrations are non-negative. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cutoff</td><td>Concentrations whose ABSOLUTE value is below cutoff times sum(abs(n_out)) are set to zero. This is applied after remove_negatives. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ZAI[itot]</td><td>ZAI identifiers of the nuclides.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>The indexing in loc must be in c style, i.e., starts from 0. Be avare of this when calling from Fortran.</dd>
<dd>
offdiag (which is called "a" in most of <a class="el" href="../../d5/dc1/namespace_origen.html">Origen</a> source code) and loc must be sorted in the special <a class="el" href="../../d5/dc1/namespace_origen.html">Origen</a> way:<ul>
<li>decay parents of first nuclide,</li>
<li>activation parents of first nuclide,</li>
<li>decay parents of second nuclide,</li>
<li>activation parents of the second,</li>
<li>and so on.</li>
</ul>
</dd>
<dd>
The culling feature from earlier versions was removed. Use internal substeps instead.</dd></dl>
<dl class="section return"><dt>Returns</dt><dd>zero on successfull exit or nonzero on failed exit. On failed exit the results (i.e., n) are unspecified. </dd></dl>
<dl><dt><b>Examples: </b></dt><dd><a class="el" href="../../da/dfe/_solver_2cram_2src_2tests_2tst_c_r_a_m_8cpp-example.html#a40">Solver/cram/src/tests/tstCRAM.cpp</a>.</dd>
</dl>
<p>References <a class="el" href="../../d6/dfe/struct_l_ustore.html#a7a13c6886afe82da55588f528325dbc9">LUstore::C</a>, <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a246b07e575efe303e340da78c4e3e15c">CopyLU()</a>, <a class="el" href="../../d6/dfe/struct_l_ustore.html#a4cba4d2a9ea00cf00f478c6fc79aca99">LUstore::equed</a>, <a class="el" href="../../d5/dc1/namespace_origen.html#acac5275310c6e0fef2672b821eb08e38">Origen::info()</a>, <a class="el" href="../../da/def/kernel__cram_8hpp.html#af79aa009834d9b4a50ef6fc96f89e5d7">kernel_cram_coefficients()</a>, <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#aff5a005e75ba1c528c5f8597d45cb1cb">makeExpmInput()</a>, <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a8109e19dd4e4009213d14ae3d68214f5">makeMatlabInput()</a>, <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a>, <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a766915c86655672579fe5205b19bc692">OrigenToCRSMatrix()</a>, <a class="el" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a>, <a class="el" href="../../d6/dfe/struct_l_ustore.html#a9fb630a8ba5f3a8bfdcafc45b3511b88">LUstore::R</a>, and <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#af2e1575f3f81b75079edded741a589e3">SORT_NUCLIDES</a>.</p>

<p>Referenced by <a class="el" href="../../dd/d7e/kernel__cram__from__fortran_8cpp.html#aa6eba8d39329bf76318552b1837726b9">kernel_cram_from_fortran()</a>, <a class="el" href="../../d4/d53/class_origen_1_1_solver__cram.html#a415be826c056e1634b7b7265380c27b3">Solver_cram::solve_impl()</a>, <a class="el" href="../../dd/d3d/tst_c_r_a_m_8cpp.html#a0bdeaebce0e26aeec0af6e5540315488">TEST()</a>, and <a class="el" href="../../dd/d3d/tst_c_r_a_m_8cpp.html#ad73d132335e244ca5bb546103cc2923d">TEST_F()</a>.</p>
<div class="fragment"><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;{</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="comment">/*** The input/output varaibles for &quot;expert mode&quot; SuperLU driver</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">     * ***********/</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    superlu_options_t options;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    SuperMatrix A;  <span class="comment">// the coefficient matrix</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordtype">int</span>* perm_r;    <span class="comment">// row permutations from partial pivoting</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordtype">int</span>* perm_c;    <span class="comment">// column permutation vector</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordtype">int</span>* etree;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordtype">char</span> equed[1];</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="keywordtype">double</span>* R;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordtype">double</span>* C;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    SuperMatrix L;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    SuperMatrix <a class="code" href="../../d5/dc1/namespace_origen.html#aea03b0efe8436243f6b90c7bfffdb759">U</a>;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordtype">void</span>* work;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordtype">int</span> lwork;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    SuperMatrix B;  <span class="comment">// righe hand side</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    SuperMatrix X;  <span class="comment">// solution</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="keywordtype">double</span> recip_pivot_growth;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="keywordtype">double</span> rcond;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordtype">double</span>* FERR;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="keywordtype">double</span>* BERR;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    mem_usage_t mem_usage;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    SuperLUStat_t stat;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d5/dc1/namespace_origen.html#acac5275310c6e0fef2672b821eb08e38">info</a>;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <a class="code" href="../../d6/dfe/struct_l_ustore.html">LUstore</a> LU[8];  <span class="comment">// store the LU decompositions for other internal substeps</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="comment">/*** Other variables</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">     * *******************************************************/</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="comment">// CRS matrix A (The modified coefficient matrix or further modified)</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keywordtype">int</span> a_n;                       <span class="comment">// size</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordtype">int</span> a_nnz;                     <span class="comment">// number of allocated elements</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordtype">double</span>* a_val;                 <span class="comment">// allocated elements</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    doublecomplex* a_val_complex;  <span class="comment">// allocated elements converted to complex</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordtype">int</span>* a_rp;                     <span class="comment">// row pointers</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keywordtype">int</span>* a_ci;                     <span class="comment">// column indices</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="keywordtype">int</span>* a_diag_idx;       <span class="comment">// indices of the diagonal elements of A</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordtype">double</span>* a_diag;        <span class="comment">// copy of the diagonal values of A</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="keywordtype">int</span> *newIdx, *oldIdx;  <span class="comment">// see sortCRSnuclides()</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordtype">double</span>*</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        src_dummy_n0;  <span class="comment">// initial concentrations of dummy nuclides for source</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordtype">int</span> nrhs;  <span class="comment">// number of different right hand sides (initial compositions)</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="comment">// to solve for in superLU</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keywordtype">double</span>* n;  <span class="comment">// concentrations of nuclides, inc. dummies.</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="comment">// this has the same inexing as n0</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    doublecomplex *Bvals, *Xvals;              <span class="comment">// internal storage of B and X</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    doublecomplex alpha0, alpha[8], theta[8];  <span class="comment">// CRAM coefficients</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="keywordtype">char</span> tmpstr[512];</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="keywordtype">int</span> i, k, s;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="comment">/*** SuperLU solver options</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">     * ************************************************/</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    set_default_options( &amp;options );  <span class="comment">// set default options</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    options.Equil = NO;          <span class="comment">// no scaling</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    options.Fact = DOFACT;       <span class="comment">// solve from scratch (for first time only)</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    options.ColPerm = MY_PERMC;  <span class="comment">// hand set column permutations (set to none)</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    options.IterRefine = NOREFINE;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    options.DiagPivotThresh = 0.0;  <span class="comment">// do not pivot unless it cannot be avoided</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    options.SymmetricMode = NO;     <span class="comment">// matrix is not symmetric</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    options.PivotGrowth = NO;       <span class="comment">// do not calculate pivotal growth</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    options.ConditionNumber = NO;   <span class="comment">// do not calculate condition number</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    options.RowPerm = NOROWPERM;    <span class="comment">// no row permutations</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="comment">// options.PrintStat = YES;      // does not do anything</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordflow">if</span>( !is_adjoint ) options.Trans = NOTRANS;  <span class="comment">// forward calculation</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="keywordflow">if</span>( is_adjoint )</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        options.Trans = TRANS;  <span class="comment">// adjoint calculation (transpose A)</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="comment">/*** Time the whole solver</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">     * *************************************************/</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    jDebugBlock( std::clock_t start = std::clock() );</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="comment">/*** Check input</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">     * ***********************************************************/</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordflow">if</span>( ( cram_order &lt; 4 ) || ( cram_order &gt; 16 ) || ( cram_order % 2 != 0 ) )</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    {</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        sprintf( tmpstr,</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                 <span class="stringliteral">&quot;%s: invalid CRAM order %d. (must be 4-16 and even)\n&quot;</span>,</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                 <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a>,</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                 cram_order );</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        SErrLine( 1, tmpstr );</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    }</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="keywordflow">if</span>( source_order &gt; cram_order / 2 - 2 )</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    {</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        sprintf(</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;            tmpstr,</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            <span class="stringliteral">&quot;%s: Source term order %d is above the maximum (cram_order/2-2)\n&quot;</span>,</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a>,</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            source_order );</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        SErrLine( 1, tmpstr );</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    }</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordflow">if</span>( ( source_order &gt;= 0 ) &amp;&amp; !( source_term ) )</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    {</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        sprintf( tmpstr,</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                 <span class="stringliteral">&quot;%s: Source term is nullptr but source term order %d\n&quot;</span>,</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                 <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a>,</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                 source_order );</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        SErrLine( 1, tmpstr );</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        sprintf( tmpstr,</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                 <span class="stringliteral">&quot;%s: source_term can only be nullptr for source_order &lt; 0\n&quot;</span>,</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                 <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a> );</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        SErrLine( 1, tmpstr );</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    }</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">if</span>( ( remove_negatives &lt; 0 ) || ( remove_negatives &gt; 2 ) )</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    {</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        sprintf( tmpstr,</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                 <span class="stringliteral">&quot;%s: remove_negatives has invalid value %d &quot;</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                 <span class="stringliteral">&quot;(valid values are 0, 1, 2)\n&quot;</span>,</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                 <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a>,</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                 remove_negatives );</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        SErrLine( 1, tmpstr );</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    }</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordflow">if</span>( cutoff &lt; 0.0 )</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    {</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        sprintf( tmpstr, <span class="stringliteral">&quot;%s: cutoff must be non-negative\n&quot;</span>, <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a> );</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        SErrLine( 1, tmpstr );</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    }</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordflow">if</span>( !n_out || !n0 || !non0 || !kd || !diag || !offdiag || !loc )</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    {</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        sprintf( tmpstr,</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                 <span class="stringliteral">&quot;%s: nullptr argument other than source_term, ZAI\n&quot;</span>,</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                 <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a> );</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        SErrLine( 1, tmpstr );</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    }</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="comment">/*** Build modified coefficient matrix A</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">     * ***********************************/</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a766915c86655672579fe5205b19bc692">OrigenToCRSMatrix</a>( &amp;a_n,</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                       &amp;a_val,</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                       &amp;a_ci,</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                       &amp;a_rp,</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                       &amp;a_diag_idx,</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                       &amp;a_nnz,</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                       &amp;newIdx,</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                       &amp;oldIdx,</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                       &amp;src_dummy_n0,</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                       itot,</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                       non,</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                       non0,</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                       kd,</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                       diag,</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                       offdiag,</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                       loc,</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                       source_term,</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                       source_order,</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                       zero_flux_step,</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                       is_adjoint,</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                       <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#af2e1575f3f81b75079edded741a589e3">SORT_NUCLIDES</a>,</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                       ZAI );</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="comment">// store a copy of the diagonal elements</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    a_diag = (<span class="keywordtype">double</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ ) a_diag[i] = a_val[a_diag_idx[i]];</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <span class="comment">// convert a_val to complex</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    a_val_complex = (doublecomplex*)calloc( a_nnz, <span class="keyword">sizeof</span>( doublecomplex ) );</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_nnz; i++ ) a_val_complex[i].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a> = a_val[i];</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    free( a_val );</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="comment">// convert to SuperLU format, note that a_* arrays are not copied</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    zCreate_CompRow_Matrix(</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        &amp;A, a_n, a_n, a_nnz, a_val_complex, a_ci, a_rp, SLU_NR, SLU_Z, SLU_GE );</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="comment">/*** Set up other junk</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">     * *****************************************************/</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="comment">// number of right hand sides (back to always having 1)</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    nrhs = 1;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="comment">// nuclide compositions</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    n = (<span class="keywordtype">double</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="comment">// Create right-hand side matrix B (itot x nrhs)</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    Bvals = (doublecomplex*)calloc( a_n * nrhs, <span class="keyword">sizeof</span>( doublecomplex ) );</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    zCreate_Dense_Matrix( &amp;B, a_n, nrhs, Bvals, a_n, SLU_DN, SLU_Z, SLU_GE );</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="comment">// Write the initial composition to B</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ )</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    {  <span class="comment">// old idx</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        Bvals[newIdx[i]].r = n0[i];</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        Bvals[newIdx[i]].i = 0.0;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    }</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="keywordflow">for</span>( i = itot; i &lt; a_n; i++ )</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    {  <span class="comment">// old idx</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        Bvals[( nrhs - 1 ) * a_n + newIdx[i]].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a> = src_dummy_n0[i - itot];</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        Bvals[( nrhs - 1 ) * a_n + newIdx[i]].i = 0.0;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    }</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="comment">// Create a matrix (itot x nrhs) to hold the solution</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    Xvals = (doublecomplex*)calloc( a_n * nrhs, <span class="keyword">sizeof</span>( doublecomplex ) );</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    zCreate_Dense_Matrix( &amp;X, a_n, nrhs, Xvals, a_n, SLU_DN, SLU_Z, SLU_GE );</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="comment">/* Column and row pivoting vectors (no pivoting) */</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    perm_r = (<span class="keywordtype">int</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    perm_c = (<span class="keywordtype">int</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    {</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        perm_r[i] = i;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        perm_c[i] = i;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    }</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="comment">// work arrays for SuperLU</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="comment">// WORK, R, C must go to LUstore. NOTE: the old recycled work</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    work = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    lwork = 0;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    etree = (<span class="keywordtype">int</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    R = (<span class="keywordtype">double</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    C = (<span class="keywordtype">double</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    FERR = (<span class="keywordtype">double</span>*)calloc( nrhs, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    BERR = (<span class="keywordtype">double</span>*)calloc( nrhs, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="comment">/* Initialize the statistics variables. */</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    StatInit( &amp;stat );</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="comment">// produce input for an external test program (Debug/development only)</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#aff5a005e75ba1c528c5f8597d45cb1cb">makeExpmInput</a>( itot,</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                   a_n,</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                   a_nnz,</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                   a_val_complex,</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                   a_ci,</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                   a_rp,</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                   delta_t,</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                   Bvals,</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                   source_term,</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                   source_order,</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                   ZAI );</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <span class="comment">// produce matlab input (for more testing)</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a8109e19dd4e4009213d14ae3d68214f5">makeMatlabInput</a>( itot, a_n, a_val_complex, a_ci, a_rp, ZAI );</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="comment">// get CRAM coefficients</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <a class="code" href="../../da/def/kernel__cram_8hpp.html#af79aa009834d9b4a50ef6fc96f89e5d7">kernel_cram_coefficients</a>( &amp;alpha0, alpha, theta, cram_order );</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    <span class="comment">// A -&gt; A*t     t = length of internal step!</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_nnz; i++ )</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        a_val_complex[i].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a> *= ( delta_t / (<span class="keywordtype">double</span>)internal_steps );</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="comment">/*** calculate n=e^{At}*n0 with CRAM</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment">     * ***************************************/</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    jDebugLine( <span class="stringliteral">&quot;Evaluating order &quot;</span> &lt;&lt; cram_order &lt;&lt; <span class="stringliteral">&quot; CRAM solution.&quot;</span> );</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    jDebugLine( <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; internal_steps &lt;&lt; <span class="stringliteral">&quot; internal substeps.&quot;</span> );</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    jDebugBlock( std::clock_t start_calc =</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                     std::clock() );  <span class="comment">// time the main loop</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="keywordflow">for</span>( s = 0; s &lt; internal_steps; s++ )</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    {</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="comment">// alpha0 term</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ ) n[oldIdx[i]] = alpha0.r * Bvals[i].r;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="comment">/*** sum over the poles ***/</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        <span class="keywordflow">for</span>( k = 0; k &lt; cram_order / 2; k++ )</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        {</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;            <span class="comment">// reuse stuff</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            <span class="keywordflow">if</span>( k == 1 &amp;&amp; s == 0 ) options.Fact = SamePattern_SameRowPerm;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;            <span class="keywordflow">if</span>( s == 1 ) options.Fact = FACTORED;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;            <span class="comment">// change variable &quot;A&quot; from (A*t) to (A*t - theta(k)*I)</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;            <span class="comment">// This is needed even when LU is recycled.</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;            <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;            {  <span class="comment">// i = new index</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                a_val_complex[a_diag_idx[i]].r =</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                    a_diag[i] * ( delta_t / (double)internal_steps ) -</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                    theta[k].r;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                a_val_complex[a_diag_idx[i]].i = -theta[k].i;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;            }</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;            <span class="comment">// Solve (A*t -theta(k)*I)x=n0 for x</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;            <span class="keywordflow">if</span>( s == 0 )</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;            {</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                <span class="comment">// On the first substep we use all the variables (memory slots)</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;                <span class="comment">// defined in kernel_cram() for each solve.</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                <span class="comment">// L,U,R,C are stored from each solve if there are internal</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                <span class="comment">// steps</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                zgssvx( &amp;options,</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                        &amp;A,</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                        perm_c,</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                        perm_r,</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                        etree,</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                        equed,</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                        R,</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                        C,</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                        &amp;L,</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                        &amp;U,</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                        &amp;work,</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                        lwork,</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                        &amp;B,</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                        &amp;X,</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                        &amp;recip_pivot_growth,</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                        &amp;rcond,</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                        FERR,</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                        BERR,</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                        &amp;mem_usage,</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                        &amp;stat,</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                        &amp;info );</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;            }</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;            {</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                <span class="comment">// After first substep we reuse the LU decompositions from the</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                <span class="comment">// first substep (U,K,R,C) stored to LU[k].</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                <span class="comment">// other stuff is the same as on the first substep.</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                zgssvx( &amp;options,</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                        &amp;A,</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                        perm_c,</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                        perm_r,</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                        etree,</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                        LU[k].equed,</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                        &amp;( LU[k].R[0] ),</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                        &amp;( LU[k].C[0] ),</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                        &amp;( LU[k].L ),</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                        &amp;( LU[k].U ),</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                        &amp;work,</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                        lwork,</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                        &amp;B,</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                        &amp;X,</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                        &amp;recip_pivot_growth,</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                        &amp;rcond,</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                        FERR,</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                        BERR,</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                        &amp;mem_usage,</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                        &amp;stat,</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                        &amp;info );</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;            }</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;            <span class="comment">// Check solver output</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            <span class="keywordflow">if</span>( info != 0 )</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            {</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                sprintf( tmpstr,</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                         <span class="stringliteral">&quot;%s: SuperLU solver failed with error code %d\n&quot;</span>,</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                         <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a>,</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                         info );</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                SErrLine( 1, tmpstr );</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;            }</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;            <span class="keywordflow">if</span>( equed[0] != <span class="charliteral">&#39;N&#39;</span> )</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;            {</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                sprintf( tmpstr,</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                         <span class="stringliteral">&quot;%s: SuperLU solver equed is not N but %s\n&quot;</span>,</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                         <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a>,</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                         equed );</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                SErrLine( 1, tmpstr );</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;            }</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;            <span class="keywordflow">if</span>( ( s == 0 ) &amp;&amp; ( internal_steps &gt; 1 ) )</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            {</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                <span class="comment">// Store the LU decomposition:</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a246b07e575efe303e340da78c4e3e15c">CopyLU</a>( &amp;L, &amp;U, &amp;( LU[k] ) );</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                <span class="comment">// These are also needed by SuperLU to ge with the decomposition</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                LU[k].<a class="code" href="../../d6/dfe/struct_l_ustore.html#a9fb630a8ba5f3a8bfdcafc45b3511b88">R</a>.resize( a_n );</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                std::copy( R, R + a_n, &amp;( LU[k].R[0] ) );</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                LU[k].<a class="code" href="../../d6/dfe/struct_l_ustore.html#a7a13c6886afe82da55588f528325dbc9">C</a>.resize( a_n );</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                std::copy( C, C + a_n, &amp;( LU[k].C[0] ) );</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                LU[k].<a class="code" href="../../d6/dfe/struct_l_ustore.html#a4cba4d2a9ea00cf00f478c6fc79aca99">equed</a>[0] = equed[0];</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            }</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            <span class="comment">/*** Add this term to the results (real part only) ***/</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;            <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )  <span class="comment">// i=new index</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                n[oldIdx[i]] +=</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                    2 * ( alpha[k].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a> * Xvals[i].<a class="code" href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a> - alpha[k].i * Xvals[i].i );</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        }</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        <span class="comment">/*** Make the substep final composition the initial for next substep</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="comment">         * ***/</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        {  <span class="comment">// old idx</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            Bvals[newIdx[i]].r = n[i];</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;            Bvals[newIdx[i]].i = 0.0;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        }</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    }</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="comment">/*** Copy the final concentrations of real nuclides to output ***/</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ ) n_out[i] = n[i];</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    <span class="comment">/*** Remove negative values from the results if that was requested ***/</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <span class="keywordtype">bool</span> cull = <span class="keyword">false</span>;  <span class="comment">// Whether to remove negatives</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="keywordflow">if</span>( remove_negatives == 0 )</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        cull = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( remove_negatives == 1 )</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        cull = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( remove_negatives == 2 )</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    {</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        cull = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        <span class="keywordflow">if</span>( is_adjoint != 0 )</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        {</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            <span class="keywordflow">if</span>( source_order &gt; 0 ) cull = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            <span class="keywordflow">if</span>( cull == <span class="keyword">true</span> )</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ )</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                    <span class="keywordflow">if</span>( n0[i] &lt; 0.0 )</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                    {</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                        cull = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                    }</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            <span class="keywordflow">if</span>( ( cull == <span class="keyword">true</span> ) &amp;&amp; ( source_order == 0 ) )</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ )</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                    <span class="keywordflow">if</span>( source_term[i][0] &lt; 0.0 )</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                    {</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                        cull = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                    }</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        }</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    }</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordflow">if</span>( cull )</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ )</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;            <span class="keywordflow">if</span>( n_out[i] &lt; 0.0 ) n_out[i] = 0.0;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    <span class="comment">/*** Apply the cutoff for atomic densities ***/</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    <span class="keywordflow">if</span>( cutoff != 0.0 )</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    {</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        <span class="keywordtype">double</span> n_tot = 0.0;</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ ) n_tot += std::fabs( n_out[i] );</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        <span class="keywordtype">double</span> n_limit = cutoff * n_tot;</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ )</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;            <span class="keywordflow">if</span>( std::fabs( n_out[i] ) &lt; n_limit ) n_out[i] = 0.0;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    }</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <span class="comment">/*** Print some statistics ***/</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    <span class="comment">// can&#39;t enable this unless it goes to STDERR (currently muddies up output</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    <span class="comment">// file)</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="comment">// jDebugBlock(StatPrint(&amp;stat));</span></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    jDebugLine(</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;        <span class="stringliteral">&quot;CRAM solution completed in &quot;</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        &lt;&lt; 1000 * (<span class="keywordtype">double</span>)( std::clock() - start ) / (<span class="keywordtype">double</span>)CLOCKS_PER_SEC</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        &lt;&lt; <span class="stringliteral">&quot; ms, of which &quot;</span></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        &lt;&lt; 1000 * (<span class="keywordtype">double</span>)( std::clock() - start_calc ) / (<span class="keywordtype">double</span>)CLOCKS_PER_SEC</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        &lt;&lt; <span class="stringliteral">&quot; ms in the main solver loop&quot;</span> );</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <span class="comment">/*** De-allocate storage ***/</span></div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    Destroy_CompRow_Matrix( &amp;A );</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    Destroy_SuperMatrix_Store( &amp;B );</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    Destroy_SuperMatrix_Store( &amp;X );</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    Destroy_SuperNode_Matrix( &amp;L );</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    Destroy_CompCol_Matrix( &amp;U );</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    StatFree( &amp;stat );</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keywordflow">if</span>( internal_steps &gt; 1 )</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <span class="keywordflow">for</span>( k = 0; k &lt; cram_order / 2; k++ )</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;        {</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            free( ( (SCformat*)LU[k].L.Store )-&gt;nzval );</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            free( ( (SCformat*)LU[k].U.Store )-&gt;nzval );</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;            free( LU[k].L.Store );</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;            free( LU[k].U.Store );</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        }</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    free( work );</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    free( Bvals );</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    free( Xvals );</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    free( perm_r );</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    free( perm_c );</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    free( n );</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    free( FERR );</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    free( BERR );</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    free( etree );</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    free( R );</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    free( C );</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    free( a_diag );</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    free( a_diag_idx );</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    free( newIdx );</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    free( oldIdx );</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    <span class="keywordflow">if</span>( source_order &gt;= 0 ) free( src_dummy_n0 );</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;}</div>
<div class="ttc" id="namespace_origen_html_aea03b0efe8436243f6b90c7bfffdb759"><div class="ttname"><a href="../../d5/dc1/namespace_origen.html#aea03b0efe8436243f6b90c7bfffdb759">Origen::U</a></div><div class="ttdeci">Quantity&lt; Unitless &gt; U</div><div class="ttdef"><b>Definition:</b> History.h:67</div></div>
<div class="ttc" id="kernel__cram_8cpp_html_aff5a005e75ba1c528c5f8597d45cb1cb"><div class="ttname"><a href="../../d6/dfc/kernel__cram_8cpp.html#aff5a005e75ba1c528c5f8597d45cb1cb">makeExpmInput</a></div><div class="ttdeci">void makeExpmInput(int itot, int a_n, int nnz, doublecomplex *a_val_complex, int *a_ci, int *rp, double delta_t, doublecomplex *Bvals, double **source_term, int source_order, int *ZAI)</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:1269</div></div>
<div class="ttc" id="struct_l_ustore_html"><div class="ttname"><a href="../../d6/dfe/struct_l_ustore.html">LUstore</a></div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:50</div></div>
<div class="ttc" id="kernel__cram_8cpp_html_af2e1575f3f81b75079edded741a589e3"><div class="ttname"><a href="../../d6/dfc/kernel__cram_8cpp.html#af2e1575f3f81b75079edded741a589e3">SORT_NUCLIDES</a></div><div class="ttdeci">#define SORT_NUCLIDES</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:24</div></div>
<div class="ttc" id="kernel__cram_8cpp_html_a8109e19dd4e4009213d14ae3d68214f5"><div class="ttname"><a href="../../d6/dfc/kernel__cram_8cpp.html#a8109e19dd4e4009213d14ae3d68214f5">makeMatlabInput</a></div><div class="ttdeci">void makeMatlabInput(int itot, int a_n, doublecomplex *a_val_complex, int *a_ci, int *a_rp, int *ZAI)</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:1387</div></div>
<div class="ttc" id="struct_l_ustore_html_a7a13c6886afe82da55588f528325dbc9"><div class="ttname"><a href="../../d6/dfe/struct_l_ustore.html#a7a13c6886afe82da55588f528325dbc9">LUstore::C</a></div><div class="ttdeci">std::vector&lt; double &gt; C</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:54</div></div>
<div class="ttc" id="_fake_factory_8cpp_html_a6deea1c2ba17f0529b284f5013940b9f"><div class="ttname"><a href="../../d8/dc8/_fake_factory_8cpp.html#a6deea1c2ba17f0529b284f5013940b9f">r</a></div><div class="ttdeci">std::shared_ptr&lt; ScaleUtils::Math::MTRand &gt; r</div><div class="ttdef"><b>Definition:</b> FakeFactory.cpp:23</div></div>
<div class="ttc" id="kernel__cram_8cpp_html_a246b07e575efe303e340da78c4e3e15c"><div class="ttname"><a href="../../d6/dfc/kernel__cram_8cpp.html#a246b07e575efe303e340da78c4e3e15c">CopyLU</a></div><div class="ttdeci">void CopyLU(SuperMatrix *L, SuperMatrix *U, LUstore *LU)</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:739</div></div>
<div class="ttc" id="kernel__cram_8hpp_html_af79aa009834d9b4a50ef6fc96f89e5d7"><div class="ttname"><a href="../../da/def/kernel__cram_8hpp.html#af79aa009834d9b4a50ef6fc96f89e5d7">kernel_cram_coefficients</a></div><div class="ttdeci">int kernel_cram_coefficients(doublecomplex *alpha0, doublecomplex *alpha, doublecomplex *theta, int cram_order)</div><div class="ttdef"><b>Definition:</b> kernel_cram_coefficients.cpp:37</div></div>
<div class="ttc" id="kernel__cram_8cpp_html_a766915c86655672579fe5205b19bc692"><div class="ttname"><a href="../../d6/dfc/kernel__cram_8cpp.html#a766915c86655672579fe5205b19bc692">OrigenToCRSMatrix</a></div><div class="ttdeci">void OrigenToCRSMatrix(int *p_a_n, double **p_a_val, int **p_a_ci, int **p_a_rp, int **p_a_diag_idx, int *p_a_nnz, int **p_newIdx, int **p_oldIdx, double **p_src_dummy_n0, int itot, int non, int *non0, int *kd, double *diag, double *offdiag, int *loc, double **source_term, int source_order, int zero_flux_step, int is_adjoint, int sort_nuclides, int *ZAI)</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:829</div></div>
<div class="ttc" id="struct_l_ustore_html_a4cba4d2a9ea00cf00f478c6fc79aca99"><div class="ttname"><a href="../../d6/dfe/struct_l_ustore.html#a4cba4d2a9ea00cf00f478c6fc79aca99">LUstore::equed</a></div><div class="ttdeci">char equed[1]</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:52</div></div>
<div class="ttc" id="kernel__cram_8cpp_html_a47f2e62c0dbebc787052c165afcada0e"><div class="ttname"><a href="../../d6/dfc/kernel__cram_8cpp.html#a47f2e62c0dbebc787052c165afcada0e">NAME</a></div><div class="ttdeci">#define NAME</div><div class="ttdoc">Identifier for error messages. </div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:38</div></div>
<div class="ttc" id="namespace_origen_html_acac5275310c6e0fef2672b821eb08e38"><div class="ttname"><a href="../../d5/dc1/namespace_origen.html#acac5275310c6e0fef2672b821eb08e38">Origen::info</a></div><div class="ttdeci">int info(const StateSet &amp;state_set, ScaleUtils::IO::DB opts, std::ostream &amp;out, std::ostream &amp;err)</div><div class="ttdef"><b>Definition:</b> Obiwan_info.cpp:160</div></div>
<div class="ttc" id="struct_l_ustore_html_a9fb630a8ba5f3a8bfdcafc45b3511b88"><div class="ttname"><a href="../../d6/dfe/struct_l_ustore.html#a9fb630a8ba5f3a8bfdcafc45b3511b88">LUstore::R</a></div><div class="ttdeci">std::vector&lt; double &gt; R</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:53</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a766915c86655672579fe5205b19bc692"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void OrigenToCRSMatrix </td>
          <td>(</td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>p_a_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double **&#160;</td>
          <td class="paramname"><em>p_a_val</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int **&#160;</td>
          <td class="paramname"><em>p_a_ci</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int **&#160;</td>
          <td class="paramname"><em>p_a_rp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int **&#160;</td>
          <td class="paramname"><em>p_a_diag_idx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>p_a_nnz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int **&#160;</td>
          <td class="paramname"><em>p_newIdx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int **&#160;</td>
          <td class="paramname"><em>p_oldIdx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double **&#160;</td>
          <td class="paramname"><em>p_src_dummy_n0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>itot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>non</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>non0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&#160;</td>
          <td class="paramname"><em>offdiag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>loc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double **&#160;</td>
          <td class="paramname"><em>source_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>source_order</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>zero_flux_step</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>is_adjoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>sort_nuclides</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>ZAI</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Convert ORIGEN form input to regular compressed row storage (CRS) matrix representing the equivalent homogeneous equations.</p>
<p>This has two main functions:</p><ul>
<li>Build the actual coefficient matrix</li>
<li>Homogenize the equations (i.e., dn/dt = An +s ==&gt; dn'/dt = A'n')</li>
</ul>
<p>which are done simultaneously. In addition this:</p><ul>
<li>Allocates all diagonal elements (even zeros)</li>
<li>Sorts nuclides by ZAI</li>
<li>Sorts each row</li>
</ul>
<p>For details about the homogenization see: </p><hr/>
<dl class="section note"><dt>Note</dt><dd>The first nine arguments are used for output. They are pointers to the variables p_&lt;name in kernel_cram()&gt; The other arguments are same as for <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a280cd76fe988677c00f96930b194e4a4">kernel_cram()</a>. The output, except for p_a_n and p_a_nnz which are scalars, will be allocated by this function. </dd></dl>
<dl><dt><b>Examples: </b></dt><dd><a class="el" href="../../da/dfe/_solver_2cram_2src_2tests_2tst_c_r_a_m_8cpp-example.html#a22">Solver/cram/src/tests/tstCRAM.cpp</a>.</dd>
</dl>
<p>References <a class="el" href="../../d6/dfc/kernel__cram_8cpp.html#a9ce670e6925467c50c380d67ffe4dbd7">sortCRSnuclides()</a>.</p>

<p>Referenced by <a class="el" href="../../da/def/kernel__cram_8hpp.html#a45c654949dcb526cf76cdd65498a4ceb">kernel_cram()</a>, <a class="el" href="../../dd/d3d/tst_c_r_a_m_8cpp.html#a28907438acfe9ad973db1a96cd1ff04f">TEST()</a>, and <a class="el" href="../../d4/d20/classtst_origen_to_c_r_s_matrix.html#a814c812a6ce6e51aa01e625e2f962f3f">tstOrigenToCRSMatrix::~tstOrigenToCRSMatrix()</a>.</p>
<div class="fragment"><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;{</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    <span class="keywordtype">int</span> num_src;        <span class="comment">// number of nonzero coefficients in source term</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    <span class="keywordtype">int</span> num_dummy;      <span class="comment">// number of dummy nuclides</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="keywordtype">int</span>* ZAI_with_src;  <span class="comment">// ZAI but with made up values for dummies appended</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    <span class="keywordtype">double</span>* src_dummy_n0 =</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        <span class="keyword">nullptr</span>;  <span class="comment">// (initial) concentrations of dummy elements</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <span class="keywordtype">int</span> i, j, p, pmax, idx_a, rowstart;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    <span class="keywordtype">int</span> a_n, a_nnz;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    jDebugLine( <span class="stringliteral">&quot;Building CRS matrix A...&quot;</span> );</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="comment">/*** Source term background work</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="comment">     * *******************************************/</span></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <span class="comment">// Count the total number of non zero coefficients in the source term</span></div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    num_src = 0;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ )</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        <span class="keywordflow">for</span>( j = 0; j &lt; source_order + 1; j++ )</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;            <span class="keywordflow">if</span>( source_term[i][j] != 0.0 ) num_src++;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    <span class="comment">// Number of source term dummy nuclides</span></div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    num_dummy = source_order + 1;</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    <span class="keywordflow">if</span>( num_dummy &gt; 0 )</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    {</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        jDebugLine( <span class="stringliteral">&quot;   Order &quot;</span> &lt;&lt; source_order &lt;&lt; <span class="stringliteral">&quot; source term with &quot;</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                                &lt;&lt; num_src</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                                &lt;&lt; <span class="stringliteral">&quot; non-zero elements&quot;</span> );</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    }</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    {</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        jDebugLine( <span class="stringliteral">&quot;   No source term&quot;</span> );</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    }</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <span class="comment">// The size of the matrix when source has been included</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="comment">// a_nnz may later be reduced if decay and transmutation get merged</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    a_n = itot + num_dummy;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    a_nnz = a_n + non + num_src + ( a_n - itot );</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="comment">// allocate</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keywordflow">if</span>( num_dummy &gt; 0 )</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    {</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        src_dummy_n0 = (<span class="keywordtype">double</span>*)calloc( num_dummy, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;        src_dummy_n0[0] = 1.0;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    }</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    <span class="comment">// Make a copy of ZAI with possible dummies appended to the end.</span></div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <span class="comment">// Dummies get large bogus ZAI so that they won&#39;t get moved in sorting</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    <span class="keywordflow">if</span>( ZAI )</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    {</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        ZAI_with_src = (<span class="keywordtype">int</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        std::copy( ZAI, ZAI + itot, ZAI_with_src );</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        <span class="keywordflow">for</span>( i = itot; i &lt; a_n; i++ ) ZAI_with_src[i] = 9000000 + ( i - itot );</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    }</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        ZAI_with_src = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    <span class="comment">/*** allocate space ***/</span></div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="comment">// These are the same as in kernel_cram()</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="keywordtype">double</span>* a_val = (<span class="keywordtype">double</span>*)calloc( a_nnz, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordtype">int</span>* a_ci = (<span class="keywordtype">int</span>*)calloc( a_nnz, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="keywordtype">int</span>* a_rp = (<span class="keywordtype">int</span>*)calloc( a_n + 1, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="keywordtype">int</span>* newIdx = (<span class="keywordtype">int</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    <span class="keywordtype">int</span>* oldIdx = (<span class="keywordtype">int</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <span class="keywordtype">int</span>* a_diag_idx = (<span class="keywordtype">int</span>*)calloc( a_n, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    <span class="comment">// work arrays</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="keywordtype">double</span>* rowval = (<span class="keywordtype">double</span>*)calloc( 2 * itot, <span class="keyword">sizeof</span>( <span class="keywordtype">double</span> ) );</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <span class="keywordtype">int</span>* rowloc = (<span class="keywordtype">int</span>*)calloc( 2 * itot, <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="comment">/*** fill in CRS form (unsorted) ***/</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    idx_a = 0;     <span class="comment">// index in a</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    rowstart = 0;  <span class="comment">// index from which the row starts in offdiag</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; itot; i++ )</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    {  <span class="comment">// rows</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        a_rp[i] = idx_a;  <span class="comment">// row i starts at...</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        <span class="comment">// copy the values (to avoid modifying the input)</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        std::copy( &amp;loc[rowstart], &amp;loc[rowstart] + non0[i], rowloc );</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;        std::copy( &amp;offdiag[rowstart], &amp;offdiag[rowstart] + non0[i], rowval );</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;        <span class="comment">// add the diagonal element to beginning of each row</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        a_val[idx_a] = diag[i];</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        a_ci[idx_a] = i;</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        idx_a++;</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        <span class="comment">/*** add offdiagonal elements ***/</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        <span class="keywordflow">if</span>( zero_flux_step )</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;            pmax = kd[i];</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;            pmax = non0[i];</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        <span class="keywordflow">for</span>( p = 0; p &lt; pmax; p++ )</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        {</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;            <span class="comment">/* nuclide ZAI[i] is produced from nuclide ZAI[rowloc[p]] */</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;            <span class="comment">// find out if matrix element (i,p) already exists</span></div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;            <span class="keywordflow">for</span>( j = a_rp[i]; j &lt; idx_a; j++ )</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;            {</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;                <span class="keywordflow">if</span>( a_ci[j] == rowloc[p] )</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                {</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                    <span class="comment">// the element already exists, add to it</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                    a_val[j] += rowval[p];</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                }</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            }</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;            <span class="keywordflow">if</span>( j == idx_a )</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;            {</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                <span class="comment">// the element does not exist, add the element</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                a_val[idx_a] = rowval[p];</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                a_ci[idx_a] = rowloc[p];</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                idx_a++;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;            }</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        }</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        <span class="comment">/*** add source term elements ***/</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        <span class="keywordflow">for</span>( j = 0; j &lt; source_order + 1; j++ )</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;            <span class="keywordflow">if</span>( ( source_term[i][j] != 0.0 ) &amp;&amp; ( !is_adjoint ) )</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;            {</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                a_val[idx_a] = source_term[i][j];</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                a_ci[idx_a] = itot + j;</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                idx_a++;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;            }</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;        <span class="comment">// next row starts at...</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        rowstart += non0[i];</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    }</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    a_rp[itot] = idx_a;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="comment">/*** add source term dummy element rows ***/</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; num_dummy; i++ )</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    {  <span class="comment">// dummy row = itot+i</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        <span class="comment">// in adjoint calculation source is on the last row so that when the</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        <span class="comment">// matrix is transposed it ends up in the last column</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        <span class="keywordflow">if</span>( is_adjoint )</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;            <span class="keywordflow">for</span>( j = 0; j &lt; itot; j++ )  <span class="comment">// columns = nuclides</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                <span class="keywordflow">if</span>( source_term[j][i] != 0.0 )</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                {</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                    a_val[idx_a] = source_term[j][i];</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                    a_ci[idx_a] = j;</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                    idx_a++;</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                }</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        <span class="comment">// the offdiagonal &quot;produce dummy from dummy&quot; element</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        <span class="comment">// note that we are left from diagonal for forward</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;        <span class="keywordflow">if</span>( ( !is_adjoint ) &amp;&amp; ( i &gt; 0 ) )</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        {</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;            a_val[idx_a] = i;</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;            a_ci[idx_a] = itot + i - 1;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;            idx_a++;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        }</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;        <span class="comment">// diagonal</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        a_val[idx_a] = 0;</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        a_ci[idx_a] = itot + i;</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        idx_a++;</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;        <span class="comment">// the offdiagonal &quot;produce dummy from dummy&quot; element</span></div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        <span class="comment">// note that we want it left of diagonal after transpose</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        <span class="keywordflow">if</span>( ( is_adjoint ) &amp;&amp; ( i &lt; num_dummy - 1 ) )</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        {</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;            a_val[idx_a] = i + 1;</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;            a_ci[idx_a] = itot + i + 1;</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;            idx_a++;</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;        }</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;        a_rp[itot + i + 1] = idx_a;</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    }</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    <span class="comment">// the real size of the system (arrays are not reallocated)</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    a_nnz = idx_a;</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    <span class="comment">/*** sort the nuclides (maybe) ***/</span></div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    <a class="code" href="../../d6/dfc/kernel__cram_8cpp.html#a9ce670e6925467c50c380d67ffe4dbd7">sortCRSnuclides</a>( a_n,</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;                     a_nnz,</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                     &amp;a_val,</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                     &amp;a_ci,</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                     &amp;a_rp,</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;                     newIdx,</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                     oldIdx,</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                     sort_nuclides,</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                     ZAI_with_src );</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    <span class="comment">/*** Sort each row by column index (insertion sort) ***/</span></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )  <span class="comment">// rows</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        <span class="keywordflow">for</span>( idx_a = a_rp[i] + 1; idx_a &lt; a_rp[i + 1]; idx_a++ )</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        {  <span class="comment">// elements on row</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;            <span class="comment">// move the idx_a:th element left until the left side is sorted</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;            <span class="keywordtype">int</span> tmp_ci = a_ci[idx_a];</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;            <span class="keywordtype">double</span> tmp_val = a_val[idx_a];</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;            j = idx_a;</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;            <span class="comment">// move each element that should be after idx_a:th one to the right</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            <span class="keywordflow">while</span>( ( j &gt; 0 ) &amp;&amp; ( j &gt; a_rp[i] ) &amp;&amp; ( a_ci[j - 1] &gt; tmp_ci ) )</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;            {</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                a_ci[j] = a_ci[j - 1];</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;                a_val[j] = a_val[j - 1];</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;                j--;</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;            }</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;            <span class="comment">// put the moved element</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;            a_ci[j] = tmp_ci;</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;            a_val[j] = tmp_val;</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;        }</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <span class="comment">/*** find diagonal element indices ***/</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    <span class="keywordflow">for</span>( i = 0; i &lt; a_n; i++ )  <span class="comment">// rows</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        <span class="keywordflow">for</span>( idx_a = a_rp[i]; idx_a &lt; a_rp[i + 1]; idx_a++ )</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;            <span class="keywordflow">if</span>( a_ci[idx_a] == i )</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;            {</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;                a_diag_idx[i] = idx_a;</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;            }</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;    <span class="comment">/*** set the return values/pointers ***/</span></div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    *p_a_n = a_n;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    *p_a_nnz = a_nnz;</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    *p_a_val = a_val;</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    *p_a_ci = a_ci;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;    *p_a_rp = a_rp;</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    *p_a_diag_idx = a_diag_idx;</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;    *p_newIdx = newIdx;</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;    *p_oldIdx = oldIdx;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    *p_src_dummy_n0 = src_dummy_n0;</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    <span class="comment">/*** free memory ***/</span></div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    free( rowval );</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;    free( rowloc );</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    <span class="keywordflow">if</span>( ZAI_with_src ) free( ZAI_with_src );</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;}</div>
<div class="ttc" id="kernel__cram_8cpp_html_a9ce670e6925467c50c380d67ffe4dbd7"><div class="ttname"><a href="../../d6/dfc/kernel__cram_8cpp.html#a9ce670e6925467c50c380d67ffe4dbd7">sortCRSnuclides</a></div><div class="ttdeci">void sortCRSnuclides(int a_n, int a_nnz, double **a_val, int **a_ci, int **a_rp, int *newIdx, int *oldIdx, int sort_nuclides, int *ZAI)</div><div class="ttdef"><b>Definition:</b> kernel_cram.cpp:1146</div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
